"use strict";(self.webpackChunknewproj=self.webpackChunknewproj||[]).push([[8809],{91280:(ve,W,t)=>{t.r(W),t.d(W,{default:()=>ne});var e=t(21272),c=t(80403),g=t(82437),N=t(71526),P=t(85963),y=t(83997),Y=t(43064),I=t(30893),z=t(54514),E=t(61535),J=t(48940),$=t.n(J),G=t(54894),Q=t(74930),U=t(17703),H=t(54729),X=t(55627),Z=t(30127),b=t(20022),f=t(45683),u=t(89974),d=t(59984),q=t(45410),_=t(42570),n=t(11714),ee=t(78101),te=t(18960),w=t(87953),se=t(41090);function oe(){const{formatMessage:o}=(0,G.A)(),{post:ae}=(0,c.ry)(),{push:le}=(0,U.W6)(),{formatAPIError:re}=(0,c.wq)(),i=(0,g.wA)(),v=(0,c.hN)(),{collectionTypes:R,singleTypes:A,isLoading:k}=(0,X.m)(),{isLoading:h,meta:L,workflows:S}=(0,ee.W)(),{isLoading:M,roles:D}=(0,H.g)(void 0,{retry:!1}),p=(0,g.d4)(w.Di),ie=(0,g.d4)(w.EJ),l=(0,g.d4)(w.NJ),F=(0,g.d4)(w.y3),[O,m]=e.useState(!1),{isLoading:B,getFeature:ce}=(0,b.b)(),[ge,fe]=e.useState(null),[V,T]=e.useState({}),a=ce("review-workflows"),j=S.flatMap(s=>s.contentTypes),{mutateAsync:de,isLoading:me}=(0,Q.useMutation)(async({workflow:s})=>{const{data:{data:r}}=await ae("/admin/review-workflows/workflows",{data:s});return r},{onSuccess(){v({type:"success",message:{id:"Settings.review-workflows.create.page.notification.success",defaultMessage:"Workflow successfully created"}})}}),x=async()=>{T({});try{const s=await de({workflow:l});return le(`/settings/review-workflows/${s.id}`),s}catch(s){return s.response.data?.error?.name==="ValidationError"&&s.response.data?.error?.details?.errors?.length>0&&fe(s.response.data?.error?.details?.errors.reduce((r,K)=>($()(r,K.path,K.message),r),{})),v({type:"warning",message:re(s)}),null}},ue=async()=>{await x()},we=()=>{T({})},C=(0,E.Wx)({enableReinitialize:!0,initialErrors:ge,initialValues:l,async onSubmit(){const s=l.contentTypes.some(r=>j.includes(r));a?.[n.hK]&&L?.workflowCount>=parseInt(a[n.hK],10)?m("workflow"):a?.[n.Dp]&&l.stages.length>=parseInt(a[n.Dp],10)?m("stage"):s?T(r=>({...r,hasReassignedContentTypes:!0})):x()},validate(s){return(0,se._)({values:s,formatMessage:o})}});return(0,Z.N)(n.p6,te.F),e.useEffect(()=>{i((0,f.JU)()),h||i((0,f.R5)({workflows:S})),k||i((0,f.xO)({collectionTypes:R,singleTypes:A})),M||i((0,f.S0)(D)),i((0,f.F6)(k||M)),i((0,f.mF)({name:""}))},[R,i,k,M,h,D,A,S]),e.useEffect(()=>{!h&&!B&&(a?.[n.hK]&&L?.workflowsTotal>=parseInt(a[n.hK],10)?m("workflow"):a?.[n.Dp]&&l.stages.length>=parseInt(a[n.Dp],10)&&m("stage"))},[B,h,a,L?.workflowsTotal,l.stages.length]),e.useEffect(()=>{!p&&F.length===0&&v({blockTransition:!0,type:"warning",message:o({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[o,p,F,v]),e.createElement(e.Fragment,null,e.createElement(u.nh,null),e.createElement(E.QI,{value:C},e.createElement(E.lV,{onSubmit:C.handleSubmit},e.createElement(u.Y9,{navigationAction:e.createElement(u.kc,{href:"/settings/review-workflows"}),primaryAction:e.createElement(P.$,{startIcon:e.createElement(z.A,null),type:"submit",size:"M",disabled:!ie,isLoading:me},o({id:"global.save",defaultMessage:"Save"})),title:o({id:"Settings.review-workflows.create.page.title",defaultMessage:"Create Review Workflow"}),subtitle:o({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:l?.stages?.length??0})}),e.createElement(u.bL,null,e.createElement(y.s,{alignItems:"stretch",direction:"column",gap:7},p?e.createElement(Y.a,null,o({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"})):e.createElement(y.s,{alignItems:"stretch",direction:"column",gap:7},e.createElement(_.r,null),e.createElement(q.e,{stages:C.values?.stages})))))),e.createElement(c.TM.Root,{isConfirmButtonLoading:p,isOpen:Object.keys(V).length>0,onToggleDialog:we,onConfirm:ue},e.createElement(c.TM.Body,null,e.createElement(y.s,{direction:"column",gap:5},V.hasReassignedContentTypes&&e.createElement(I.o,{textAlign:"center",variant:"omega"},o({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:j.filter(s=>l.contentTypes.includes(s)).length})),e.createElement(I.o,{textAlign:"center",variant:"omega"},o({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"}))))),e.createElement(d.bL,{isOpen:O==="workflow",onClose:()=>m(!1)},e.createElement(d.hE,null,o({id:"Settings.review-workflows.create.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})),e.createElement(d.nB,null,o({id:"Settings.review-workflows.create.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."}))),e.createElement(d.bL,{isOpen:O==="stage",onClose:()=>m(!1)},e.createElement(d.hE,null,o({id:"Settings.review-workflows.create.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})),e.createElement(d.nB,null,o({id:"Settings.review-workflows.create.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."}))))}function ne(){const o=(0,g.d4)(N.G);return e.createElement(c.kz,{permissions:o.settings["review-workflows"].create},e.createElement(oe,null))}}}]);
