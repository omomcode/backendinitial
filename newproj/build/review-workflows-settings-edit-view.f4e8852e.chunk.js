"use strict";(self.webpackChunknewproj=self.webpackChunknewproj||[]).push([[277],{63108:(Ae,x,t)=>{t.r(x),t.d(x,{default:()=>fe});var e=t(21272),c=t(80403),a=t(82437),B=t(71526),Q=t(85963),T=t(83997),X=t(43064),I=t(30893),Z=t(54514),A=t(61535),b=t(48940),q=t.n(b),_=t(54894),ee=t(74930),te=t(17703),se=t(54729),oe=t(55627),ne=t(30127),ae=t(20022),f=t(45683),y=t(89974),m=t(59984),re=t(45410),le=t(42570),r=t(11714),ie=t(78101),de=t(18960),u=t(87953),ce=t(41090);function ge(){const{workflowId:E}=(0,te.g)(),me=(0,a.d4)(B.G),{formatMessage:o}=(0,_.A)(),g=(0,a.wA)(),{put:ue}=(0,c.ry)(),{formatAPIError:we}=(0,c.wq)(),S=(0,c.hN)(),{isLoading:v,meta:k,workflows:L,refetch:ve}=(0,ie.W)(),{collectionTypes:P,singleTypes:V,isLoading:D}=(0,oe.m)(),he=(0,a.d4)(u.Hc),pe=(0,a.d4)(u.EJ),l=(0,a.d4)(u.NJ),K=(0,a.d4)(u.If),N=(0,a.d4)(u.y3),h=(0,a.d4)(u.Di),{allowedActions:{canDelete:ye,canUpdate:R}}=(0,c.ec)(me.settings["review-workflows"]),[M,C]=e.useState({}),{getFeature:Ee,isLoading:Y}=(0,ae.b)(),{isLoading:W,roles:z}=(0,se.g)(void 0,{retry:!1}),[J,w]=e.useState(!1),[Se,U]=e.useState(null),G=L.find(s=>s.id===parseInt(E,10)),$=L.filter(s=>s.id!==parseInt(E,10)).flatMap(s=>s.contentTypes),{mutateAsync:ke,isLoading:Le}=(0,ee.useMutation)(async({workflow:s})=>{const{data:{data:n}}=await ue(`/admin/review-workflows/workflows/${s.id}`,{data:s});return n},{onSuccess(){S({type:"success",message:{id:"notification.success.saved",defaultMessage:"Saved"}})}}),Me=async s=>{U(null);try{return await ke({workflow:{...s,stages:s.stages.map(d=>{let p=!0;const O=he.workflow.stages.find(j=>j.id===d?.id);return O&&(p=O.permissions?.length!==d.permission?.length||!O.permissions.every(j=>!!d.permissions.find(Ie=>Ie.role===j.role))),{...d,permissions:p?d.permissions:void 0}})}})}catch(n){return n.response.data?.error?.name==="ValidationError"&&n.response.data?.error?.details?.errors?.length>0&&U(n.response.data?.error?.details?.errors.reduce((d,p)=>(q()(d,p.path,p.message),d),{})),S({type:"warning",message:we(n)}),null}},H=async()=>{await Me(l),await ve(),C({})},Ce=async()=>{await H()},Te=()=>{C({})},F=(0,A.Wx)({enableReinitialize:!0,initialErrors:Se,initialValues:l,async onSubmit(){const s=l.contentTypes.some(n=>$.includes(n));i?.[r.hK]&&k?.workflowCount>parseInt(i[r.hK],10)?w("workflow"):i?.[r.Dp]&&l.stages.length>parseInt(i[r.Dp],10)?w("stage"):K||s?(K&&C(n=>({...n,hasDeletedServerStages:!0})),s&&C(n=>({...n,hasReassignedContentTypes:!0}))):H()},validate(s){return(0,ce._)({values:s,formatMessage:o})}});(0,ne.N)(r.p6,de.F);const i=Ee("review-workflows");return e.useEffect(()=>(v||(g((0,f.yX)({workflow:G})),g((0,f.R5)({workflows:L}))),D||g((0,f.xO)({collectionTypes:P,singleTypes:V})),W||g((0,f.S0)(z)),g((0,f.F6)(v||D||W)),()=>{g((0,f.JU)())}),[P,g,D,v,W,z,V,G,L]),e.useEffect(()=>{!v&&!Y&&(i?.[r.hK]&&k?.workflowCount>parseInt(i[r.hK],10)?w("workflow"):i?.[r.Dp]&&l.stages.length>parseInt(i[r.Dp],10)&&w("stage"))},[l.stages.length,Y,v,i,k?.workflowCount,k.workflowsTotal]),e.useEffect(()=>{!h&&N.length===0&&S({blockTransition:!0,type:"warning",message:o({id:"Settings.review-workflows.stage.permissions.noPermissions.description",defaultMessage:"You don\u2019t have the permission to see roles"})})},[o,h,N,S]),e.createElement(e.Fragment,null,e.createElement(y.nh,null),e.createElement(A.QI,{value:F},e.createElement(A.lV,{onSubmit:F.handleSubmit},e.createElement(y.Y9,{navigationAction:e.createElement(y.kc,{href:"/settings/review-workflows"}),primaryAction:R&&e.createElement(Q.$,{startIcon:e.createElement(Z.A,null),type:"submit",size:"M",disabled:!pe,loading:!Object.keys(M).length>0&&Le},o({id:"global.save",defaultMessage:"Save"})),subtitle:!h&&o({id:"Settings.review-workflows.page.subtitle",defaultMessage:"{count, plural, one {# stage} other {# stages}}"},{count:l.stages.length}),title:l.name}),e.createElement(y.bL,null,h?e.createElement(T.s,{justifyContent:"center"},e.createElement(X.a,null,o({id:"Settings.review-workflows.page.isLoading",defaultMessage:"Workflow is loading"}))):e.createElement(T.s,{alignItems:"stretch",direction:"column",gap:7},e.createElement(le.r,{canUpdate:R}),e.createElement(re.e,{canDelete:ye,canUpdate:R,stages:F.values?.stages}))))),e.createElement(c.TM.Root,{isConfirmButtonLoading:h,isOpen:Object.keys(M).length>0,onToggleDialog:Te,onConfirm:Ce},e.createElement(c.TM.Body,null,e.createElement(T.s,{direction:"column",gap:5},M.hasDeletedServerStages&&e.createElement(I.o,{textAlign:"center",variant:"omega"},o({id:"Settings.review-workflows.page.delete.confirm.stages.body",defaultMessage:"All entries assigned to deleted stages will be moved to the previous stage."})),M.hasReassignedContentTypes&&e.createElement(I.o,{textAlign:"center",variant:"omega"},o({id:"Settings.review-workflows.page.delete.confirm.contentType.body",defaultMessage:"{count} {count, plural, one {content-type} other {content-types}} {count, plural, one {is} other {are}} already mapped to {count, plural, one {another workflow} other {other workflows}}. If you save changes, {count, plural, one {this} other {these}} {count, plural, one {content-type} other {{count} content-types}} will no more be mapped to the {count, plural, one {another workflow} other {other workflows}} and all corresponding information will be removed."},{count:$.filter(s=>l.contentTypes.includes(s)).length})),e.createElement(I.o,{textAlign:"center",variant:"omega"},o({id:"Settings.review-workflows.page.delete.confirm.confirm",defaultMessage:"Are you sure you want to save?"}))))),e.createElement(m.bL,{isOpen:J==="workflow",onClose:()=>w(!1)},e.createElement(m.hE,null,o({id:"Settings.review-workflows.edit.page.workflows.limit.title",defaultMessage:"You\u2019ve reached the limit of workflows in your plan"})),e.createElement(m.nB,null,o({id:"Settings.review-workflows.edit.page.workflows.limit.body",defaultMessage:"Delete a workflow or contact Sales to enable more workflows."}))),e.createElement(m.bL,{isOpen:J==="stage",onClose:()=>w(!1)},e.createElement(m.hE,null,o({id:"Settings.review-workflows.edit.page.stages.limit.title",defaultMessage:"You have reached the limit of stages for this workflow in your plan"})),e.createElement(m.nB,null,o({id:"Settings.review-workflows.edit.page.stages.limit.body",defaultMessage:"Try deleting some stages or contact Sales to enable more stages."}))))}function fe(){const E=(0,a.d4)(B.G);return e.createElement(c.kz,{permissions:E.settings["review-workflows"].main},e.createElement(ge,null))}}}]);
